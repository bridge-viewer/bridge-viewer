<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>桥梁地形云图在线查看器</title>
<style>
:root{
  --bg:#cccccc;            /* 场景与图例背景保持一致 */
  --panel:#ffffffee; --text:#222; --muted:#667085;
  --primary:#315cf0; --primary-weak:#e7ecff; --border:#d9d9d9; --shadow:0 6px 20px rgba(0,0,0,.08);
  --safe-b: env(safe-area-inset-bottom, 12px);
}
*{box-sizing:border-box} body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Microsoft YaHei",sans-serif;color:var(--text);}

/* 顶栏 + 工具栏 */
#topbar{position:sticky;top:0;z-index:30;display:flex;gap:10px;align-items:center;padding:10px 12px;background:var(--panel);backdrop-filter:saturate(180%) blur(6px);border-bottom:1px solid var(--border)}
#logo{width:32px;height:32px;border-radius:50%}
#title{font-size:16px;font-weight:700}
#brand{margin-left:auto;display:flex;align-items:center;gap:8px}
#brand img{width:36px;height:36px;border-radius:50%}
#brand .name{font-weight:700;color:#22314a;font-size:14px}

#toolbar{position:sticky;top:54px;z-index:25;display:grid;grid-template-columns:repeat(12,1fr);gap:8px;padding:10px 12px;background:var(--panel);border-bottom:1px solid var(--border)}
.row{display:contents}
.group{display:flex;gap:8px;align-items:center;background:#fff;border:1px solid var(--border);border-radius:10px;padding:8px 10px;box-shadow:var(--shadow)}
.group label{font-size:13px;color:var(--muted)}
select,button,input[type=range]{font-size:14px;border:1px solid var(--border);border-radius:8px;background:#fff;color:var(--text);padding:6px 10px}
select{min-width:140px} button.primary{background:var(--primary);border-color:var(--primary);color:#fff}
.toggle{padding:6px 10px;border-radius:20px;background:var(--primary-weak);border-color:#cbd5ff;color:#2946b8}
.toggle[aria-pressed="true"]{background:var(--primary);color:#fff;border-color:var(--primary)}
.muted{color:var(--muted)}
#g1{grid-column:span 12} #g2{grid-column:span 12}
@media (min-width:860px){ #g1{grid-column:span 7} #g2{grid-column:span 5} }

/* 主视区 */
#container{position:fixed;inset:0;top:128px}

/* 底部 HUD / 水印 / 小坐标系：永远在可视底部（手机也可见） */
#hud{position:fixed;left:12px;bottom:var(--safe-b);transform:translateY(-6px);background:rgba(0,0,0,.7);color:#fff;padding:8px 10px;border-radius:8px;font-size:13px;white-space:pre;z-index:24}
#wm{position:fixed;left:12px;bottom:calc(var(--safe-b) + 64px);opacity:.10;z-index:10;pointer-events:none}
#wm img{width:96px;height:96px;object-fit:contain}
#axisWrap{position:fixed;right:12px;bottom:var(--safe-b);width:160px;height:160px;pointer-events:none;z-index:24}
#axisCanvas{position:absolute;inset:0;width:160px;height:160px;background:transparent;pointer-events:auto}

/* 居中加载进度条 */
#progressWrap{
  position:fixed; left:50%; top:50%; transform:translate(-50%,-50%);
  min-width:240px; padding:12px 16px; background:rgba(0,0,0,.7); color:#fff;
  border-radius:12px; z-index:40; display:none; text-align:center;
  box-shadow:0 8px 30px rgba(0,0,0,.25);
}
#progressBar{width:100%; height:10px; background:rgba(255,255,255,.25); border-radius:999px; overflow:hidden; margin-top:8px}
#progressFill{height:100%; width:0%; background:#4ad5ff; border-radius:999px; transition:width .2s ease}

/* 左侧图例：背景匹配场景色；刻度 Times New Roman，靠近色带并置于其左侧 */
#legendDock{
  position:fixed; left:12px; top:50%; transform:translateY(-50%); z-index:22;
  display:flex; flex-direction:column; align-items:flex-start; gap:6px; pointer-events:none;
}
#legendTitle{
  font-size:12px; color:#333; background:var(--bg); padding:4px 6px; border-radius:6px;
  border:1px solid rgba(0,0,0,.2);
}
#legendWrap{
  display:flex; align-items:flex-start; gap:6px;
  background:var(--bg); border:1px solid rgba(0,0,0,.25);
  border-radius:6px; padding:6px; pointer-events:auto;
}
#legend{display:block; width:24px; height:240px; border:1px solid #888}
#legendTicks{
  display:flex; flex-direction:column; gap:0; font-size:12px; color:#000;
  font-family:"Times New Roman", Times, serif; line-height:1; width:46px; text-align:right;
}
#legendTicks div{height:calc(240px/10); display:flex; align-items:center; justify-content:flex-end; padding-right:2px}

/* 顶部状态文本（仍保留） */
#status{margin-left:auto}
</style>

<script type="importmap">{"imports":{"three":"./three.module.js"}}</script>
</head>
<body>
  <!-- 顶栏 -->
  <header id="topbar">
    <img id="logo" src="./logo.png" alt="logo"/>
    <div id="title">桥梁地形云图在线查看器</div>
    <div id="brand"><img src="./logo.png" alt="长安大学"/><span class="name">长安大学</span></div>
  </header>

  <!-- 工具栏（两行） -->
  <section id="toolbar">
    <div id="g1" class="row">
      <div class="group" style="grid-column:span 12;">
        <label>桥梁</label><select id="bridgeSel"></select>
        <label>时间</label><select id="dateSel"></select>
        <button id="loadBtn" class="primary">加载</button>
        <span id="status" class="muted">就绪</span>
      </div>
    </div>
    <div id="g2" class="row">
      <div class="group" style="grid-column:span 12;flex-wrap:wrap">
        <button id="modeBtn" class="toggle" aria-pressed="false">网格</button>
        <label>点大小</label><input type="range" id="pointSize" min="0.5" max="5" step="0.1" value="1.5" style="width:160px">
        <button id="pickBtn" class="toggle" aria-pressed="false">拾取</button>
        <button id="measureBtn" class="toggle" aria-pressed="false">测距</button>
        <button id="clearBtn" class="toggle" aria-pressed="false">清除</button>
      </div>
    </div>
  </section>

  <!-- 主视区 -->
  <div id="container"></div>

  <!-- 左侧图例（标题 + 离散色条 + 刻度） -->
  <aside id="legendDock">
    <div id="legendTitle">水深 / m</div>
    <div id="legendWrap">
      <div id="legendTicks"></div>
      <canvas id="legend" width="24" height="240"></canvas>
    </div>
  </aside>

  <!-- 居中进度条 -->
  <div id="progressWrap">
    <div id="progressText">加载中…</div>
    <div id="progressBar"><div id="progressFill"></div></div>
  </div>

  <!-- 底部 HUD / 小坐标系 / 水印 -->
  <div id="hud">提示：启用“拾取”或“测距”后，在模型上点击。</div>
  <div id="axisWrap"><canvas id="axisCanvas" width="160" height="160"></canvas></div>
  <div id="wm"><img src="./logo.png" alt="长安大学水印"/></div>

  <script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from './OrbitControls.js';
    import { PLYLoader } from './PLYLoader.js';

    /* 场景 */
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(getComputedStyle(document.documentElement).getPropertyValue('--bg').trim());
    const camera = new THREE.PerspectiveCamera(60, window.innerWidth/(window.innerHeight-128), 0.1, 100000);
    camera.position.set(100,100,100);

    const renderer = new THREE.WebGLRenderer({antialias:true});
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.setSize(window.innerWidth, window.innerHeight-128);
    document.getElementById('container').appendChild(renderer.domElement);
    renderer.domElement.tabIndex = 0;

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;

    scene.add(new THREE.AmbientLight(0xffffff, 0.6));
    const d = new THREE.DirectionalLight(0xffffff, 0.9); d.position.set(120,220,120); scene.add(d);

    const root = new THREE.Group(); scene.add(root);

    /* 小坐标系（正交） */
    const axisScene = new THREE.Scene();
    const AXIS_UNITS = 2.2;
    const axisCamera = new THREE.OrthographicCamera(-AXIS_UNITS, AXIS_UNITS, AXIS_UNITS, -AXIS_UNITS, -10, 10);
    axisCamera.position.set(0,0,2); axisCamera.up.set(0,1,0); axisCamera.lookAt(0,0,0);
    const axisRenderer = new THREE.WebGLRenderer({canvas: document.getElementById('axisCanvas'), alpha:true, antialias:true});
    axisRenderer.setSize(160,160);
    const mini = new THREE.Group(); axisScene.add(mini); mini.scale.set(0.95,0.95,0.95);
    function makeLabelSprite(t,c){const s=128,cv=document.createElement('canvas');cv.width=cv.height=s;const ctx=cv.getContext('2d');
      ctx.clearRect(0,0,s,s);ctx.fillStyle=c;ctx.font='bold 72px Arial';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText(t,s/2,s/2);
      const tx=new THREE.CanvasTexture(cv);return new THREE.Sprite(new THREE.SpriteMaterial({map:tx,transparent:true}))}
    function addAxis(dir,color,name){const len=1.35, headLen=0.33, headWid=0.21;
      const ah=new THREE.ArrowHelper(dir,new THREE.Vector3(0,0,0),len,color,headLen,headWid); mini.add(ah);
      const sp=makeLabelSprite(name,'#000'); sp.scale.set(0.9,0.9,0.9); sp.position.copy(dir.clone().multiplyScalar(1.5)); mini.add(sp);}
    addAxis(new THREE.Vector3(1,0,0),0xff4444,'X'); addAxis(new THREE.Vector3(0,1,0),0x44ff44,'Y'); addAxis(new THREE.Vector3(0,0,1),0x4488ff,'Z');

    /* UI */
    const statusEl=document.getElementById('status');
    const hud=document.getElementById('hud');
    const pointSize=document.getElementById('pointSize');
    const modeBtn=document.getElementById('modeBtn');
    const pickBtn=document.getElementById('pickBtn');
    const measureBtn=document.getElementById('measureBtn');
    const clearBtn=document.getElementById('clearBtn');

    // 居中进度
    const progressWrap = document.getElementById('progressWrap');
    const progressText = document.getElementById('progressText');
    const progressFill = document.getElementById('progressFill');

    /* 变量 */
    const loader=new PLYLoader(); let currentObj=null, asPoints=false;
    let measureA=null, measureB=null, measureLine=null, measureAMarker=null, measureBMarker=null;
    let pickMarker=null; const rc=new THREE.Raycaster(), mouse=new THREE.Vector2();

    /* 图例：固定“水深 / m”，-10~-4，10 段离散（可被 *.legend.json 覆盖范围与颜色） */
    const legendCv=document.getElementById('legend'); const lctx=legendCv.getContext('2d'); const ticksEl=document.getElementById('legendTicks');
    let legendSpec = {
      min:-10.0, max:-4.0,
      colors: ['#0010a8','#123fdf','#1491ff','#18cfff','#18fffb','#55ff13','#c7ff00','#ffd200','#ff7a00','#e10000'] // 底→顶
    };
    function drawLegendDiscrete(){
      const n=legendSpec.colors.length, w=legendCv.width, h=legendCv.height, seg=h/n;
      lctx.clearRect(0,0,w,h);
      for(let i=0;i<n;i++){
        const y=h - (i+1)*seg;
        lctx.fillStyle=legendSpec.colors[i];
        lctx.fillRect(0, y, w, seg);
        lctx.strokeStyle="#888"; lctx.lineWidth=1; lctx.strokeRect(0, y, w, seg);
      }
      ticksEl.innerHTML='';
      const ticks=10, top=legendSpec.max, bot=legendSpec.min;
      for(let i=0;i<ticks;i++){
        const v = top - (i)*( (top-bot)/(ticks-1) );
        const d=document.createElement('div'); d.textContent = v.toFixed(3); ticksEl.appendChild(d);
      }
    }
    drawLegendDiscrete();

    async function tryLoadLegend(plyUrl){
      try{
        const u = new URL(plyUrl, location.href), name=u.pathname.split('/').pop(), base=name.replace(/\.ply$/i,'');
        u.pathname = u.pathname.replace(name, base+'.legend.json');
        const r = await fetch(u.href+'?_='+Date.now()); if(!r.ok) return;
        const j = await r.json(); const s=j.legend||j;
        if(s.min!=null && s.max!=null && Array.isArray(s.stops)){
          const cols = s.stops.map(p=>p[1]);
          legendSpec = {min:s.min, max:s.max, colors: cols};
          drawLegendDiscrete();
        }
      }catch(_){}
    }

    /* 工具函数 */
    function sceneScale(){const b=new THREE.Box3().setFromObject(root);const s=b.getSize(new THREE.Vector3());return Math.max(s.x,s.y,s.z)||1;}
    function makeMarker(color){const s=sceneScale()*0.012;const g=new THREE.SphereGeometry(s,16,16);
      const m=new THREE.MeshBasicMaterial({color});const o=new THREE.Mesh(g,m);
      const edge=new THREE.Mesh(new THREE.SphereGeometry(s*1.35,16,16), new THREE.MeshBasicMaterial({color:0xffffff,opacity:.85,transparent:true}));
      const grp=new THREE.Group(); grp.add(edge); grp.add(o); return grp;}
    function makeMeasureLine(a,b){const geo=new THREE.BufferGeometry().setFromPoints([a,b]);
      const mat=new THREE.LineBasicMaterial({color:0x00e0ff,linewidth:2,transparent:true,opacity:.95}); return new THREE.Line(geo,mat);}
    function updateMeasureLine(){if(measureLine&&measureA&&measureB){const p=measureLine.geometry.attributes.position.array;
      p[0]=measureA.x;p[1]=measureA.y;p[2]=measureA.z;p[3]=measureB.x;p[4]=measureB.y;p[5]=measureB.z;
      measureLine.geometry.attributes.position.needsUpdate=true;measureLine.geometry.computeBoundingSphere?.();}}

    function fitObject(obj){const b=new THREE.Box3().setFromObject(obj);const s=b.getSize(new THREE.Vector3());
      const c=b.getCenter(new THREE.Vector3());const md=Math.max(s.x,s.y,s.z)||1;const dist=md/(2*Math.tan(Math.PI*camera.fov/360));
      camera.position.copy(c.clone().add(new THREE.Vector3(1,1,1).normalize().multiplyScalar(dist*2)));
      controls.target.copy(c);controls.update();camera.near=Math.max(0.01,dist/1000);camera.far=dist*10000;camera.updateProjectionMatrix();}

    function clearMeasure(){measureA=measureB=null;
      if(measureLine){root.remove(measureLine);measureLine.geometry.dispose();measureLine.material.dispose();measureLine=null;}
      if(measureAMarker){root.remove(measureAMarker);measureAMarker=null;}
      if(measureBMarker){root.remove(measureBMarker);measureBMarker=null;}}
    function clearPick(){if(pickMarker){root.remove(pickMarker);pickMarker=null;}}
    function clearScene(){if(currentObj){root.remove(currentObj);currentObj.geometry?.dispose?.();currentObj.material?.dispose?.();currentObj=null;}
      clearMeasure();clearPick();hud.textContent='提示：启用“拾取”或“测距”后，在模型上点击。';}

    /* 渲染对象（默认网格） */
    function makePoints(geo){const hasColor=!!geo.getAttribute('color');const mat=new THREE.PointsMaterial({size:parseFloat(pointSize.value),vertexColors:hasColor});return new THREE.Points(geo,mat);}
    function makeMesh(geo){if(geo.index) geo=geo.toNonIndexed(); geo.computeVertexNormals?.();const mat=new THREE.MeshLambertMaterial({vertexColors:true,side:THREE.DoubleSide});return new THREE.Mesh(geo,mat);}

    async function loadPLY(url){
      statusEl.textContent='加载中...';
      progressWrap.style.display='block';
      progressText.textContent='加载中…';
      progressFill.style.width='0%';

      clearScene();
      tryLoadLegend(url);

      loader.load(url,(geo)=>{
        geo.computeBoundingBox?.();
        currentObj = asPoints? makePoints(geo): makeMesh(geo);
        root.add(currentObj);
        fitObject(currentObj);
        statusEl.textContent='加载完成';
        progressFill.style.width='100%';
        progressText.textContent='100%';
        setTimeout(()=>{progressWrap.style.display='none';}, 400);
      },(xhr)=>{
        // 仅在 total 有值时显示百分比；防止 >100%，这里最多到 99%
        if (xhr.total){
          const pct = Math.min(99, Math.floor(xhr.loaded / xhr.total * 100));
          progressFill.style.width = pct + '%';
          progressText.textContent = pct + '%';
          statusEl.textContent = '下载 ' + pct + '%';
        }else{
          // 未提供 total：显示动态条（可选简化为文字）
          progressText.textContent = '加载中…';
          const cur = parseFloat(progressFill.style.width) || 0;
          const nxt = (cur + 2) % 90; // 0~90 来回
          progressFill.style.width = nxt + '%';
        }
      },(err)=>{
        console.error(err);
        statusEl.textContent='加载失败';
        progressText.textContent='加载失败';
        setTimeout(()=>{progressWrap.style.display='none';}, 1200);
      });
    }

    pointSize.addEventListener('input',()=>{ if(currentObj&&currentObj.material&&currentObj.material.size!==undefined){currentObj.material.size=parseFloat(pointSize.value);} });

    function toggle(btn){btn.setAttribute('aria-pressed', btn.getAttribute('aria-pressed')==='true'?'false':'true');}
    function isOn(btn){return btn.getAttribute('aria-pressed')==='true';}
    modeBtn.addEventListener('click',()=>{ asPoints=!asPoints; modeBtn.textContent=asPoints?'点云':'网格';
      if(currentObj&&currentScene?.plyUrl) loadPLY(currentScene.plyUrl);});
    pickBtn.addEventListener('click',()=>{ toggle(pickBtn); if(isOn(pickBtn)) pickBtn.textContent='拾取✓'; else pickBtn.textContent='拾取';
      if(isOn(pickBtn)) {measureBtn.setAttribute('aria-pressed','false'); measureBtn.textContent='测距';}});
    measureBtn.addEventListener('click',()=>{ toggle(measureBtn); if(isOn(measureBtn)) measureBtn.textContent='测距✓'; else measureBtn.textContent='测距';
      if(isOn(measureBtn)) {pickBtn.setAttribute('aria-pressed','false'); pickBtn.textContent='拾取';}});
    clearBtn.addEventListener('click',()=>{ clearMeasure(); clearPick(); hud.textContent='已清除测距/拾取结果'; });

    /* 主画布点击：拾取/测距（带标记+线段） */
    renderer.domElement.addEventListener('pointerdown',(e)=>{
      if(!currentObj) return; if(!isOn(pickBtn)&&!isOn(measureBtn)) return;
      const r=renderer.domElement.getBoundingClientRect(); const mouse=new THREE.Vector2(
        ((e.clientX-r.left)/r.width)*2-1, -((e.clientY-r.top)/r.height)*2+1 );
      const rc=new THREE.Raycaster(); rc.setFromCamera(mouse,camera);
      const h=rc.intersectObject(currentObj,true); if(!h.length) return; const p=h[0].point.clone();

      if(isOn(pickBtn)){ clearPick(); pickMarker=makeMarker(0x9a4dff); pickMarker.position.copy(p); root.add(pickMarker);
        hud.textContent=`拾取\nX:${p.x.toFixed(3)}\nY:${p.y.toFixed(3)}\nZ:${p.z.toFixed(3)}`; }
      if(isOn(measureBtn)){
        if(!measureA){ measureA=p.clone(); if(measureAMarker) root.remove(measureAMarker);
          measureAMarker=makeMarker(0x00e0ff); measureAMarker.position.copy(measureA); root.add(measureAMarker);
          hud.textContent=`测距(A)\nX:${measureA.x.toFixed(3)}\nY:${measureA.y.toFixed(3)}\nZ:${measureA.z.toFixed(3)}`; }
        else if(!measureB){ measureB=p.clone(); if(measureBMarker) root.remove(measureBMarker);
          measureBMarker=makeMarker(0xff6a00); measureBMarker.position.copy(measureB); root.add(measureBMarker);
          if(!measureLine){ measureLine=makeMeasureLine(measureA,measureB); root.add(measureLine);} else updateMeasureLine();
          const dx=measureB.x-measureA.x, dy=measureB.y-measureA.y, dz=measureB.z-measureA.z; const D=Math.sqrt(dx*dx+dy*dy+dz*dz);
          hud.textContent=`ΔX:${dx.toFixed(3)}\nΔY:${dy.toFixed(3)}\nΔZ:${dz.toFixed(3)}\nD:${D.toFixed(3)}`; }
        else{ clearMeasure(); measureA=p.clone();
          measureAMarker=makeMarker(0x00e0ff); measureAMarker.position.copy(measureA); root.add(measureAMarker);
          hud.textContent=`测距(A)\nX:${measureA.x.toFixed(3)}\nY:${measureA.y.toFixed(3)}\nZ:${measureA.z.toFixed(3)}`; }
      }
    });

    /* 下拉数据 */
    let bridges=[], scenes=[], currentScene=null;
    async function loadIndex(){
      const res=await fetch('./index.json?_='+Date.now()); const data=await res.json();
      bridges=data.bridges||[]; scenes=data.scenes||[];
      document.getElementById('bridgeSel').innerHTML=bridges.map(b=>`<option value="${b.id}">${b.name}</option>`).join('');
      fillDates(); const id=document.getElementById('dateSel').value; currentScene=scenes.find(x=>x.id===id); if(currentScene) loadPLY(currentScene.plyUrl);
    }
    function fillDates(){const bid=document.getElementById('bridgeSel').value; const arr=scenes.filter(s=>s.bridgeId===bid);
      document.getElementById('dateSel').innerHTML=arr.map(s=>`<option value="${s.id}">${s.date}</option>`).join('');}
    document.getElementById('bridgeSel').addEventListener('change',()=>{fillDates(); const id=document.getElementById('dateSel').value; currentScene=scenes.find(x=>x.id===id);});
    document.getElementById('dateSel').addEventListener('change',()=>{const id=document.getElementById('dateSel').value; currentScene=scenes.find(x=>x.id===id);});
    document.getElementById('loadBtn').addEventListener('click',()=>{const id=document.getElementById('dateSel').value; currentScene=scenes.find(x=>x.id===id); if(currentScene) loadPLY(currentScene.plyUrl);});

    /* 视图对正 */
    function getCenter(){ if(root.children.length===0) return new THREE.Vector3(); return new THREE.Box3().setFromObject(root).getCenter(new THREE.Vector3());}
    function distTo(c){ return camera.position.clone().sub(c).length(); }
    function snapToAxis(a){ const c=getCenter(); const dist=Math.max(1,distTo(c)); let pos=new THREE.Vector3(); let up=new THREE.Vector3(0,0,1);
      if(a==='X'){pos.set(dist,0,0); up.set(0,0,1);} if(a==='Y'){pos.set(0,dist,0); up.set(0,0,1);} if(a==='Z'){pos.set(0,0,dist); up.set(0,1,0);}
      camera.up.copy(up); camera.position.copy(c.clone().add(pos)); controls.target.copy(c); controls.update(); }

    /* 自适应 */
    window.addEventListener('resize',()=>{ camera.aspect=window.innerWidth/(window.innerHeight-128); camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight-128); axisRenderer.setSize(160,160); });

    /* 渲染循环 */
    (function ani(){ requestAnimationFrame(ani); controls.update(); renderer.render(scene,camera);
      mini.quaternion.copy(camera.quaternion); axisCamera.lookAt(0,0,0); axisRenderer.render(axisScene,axisCamera); })();

    loadIndex();
  </script>
</body>
</html>
